links: [[es6.目录]]

# Promise 对象

**JavaScript 是一个单线程的编程语言，通过异步、回调函数来处理各种事件**。因此，如果要处理多个有先后顺序的事件，那么将会出现多次嵌套回调函数的情况，这也被很多开发人员称为『回调地狱』。

Promise 对象则是通过将代表异步操作最终完成或者失败的操作封装到了对象中。Promise 本质上是一个绑定了回调的对象，不过这样可以适当缓解多层回调函数的问题。

在 Promise 的规定中，每个 Promise 对象都有『状态』，Promise 对象的初始状态是 _pending_ ，接下来，它可以变成 _fulfilled_<small>（代表成功）</small>或者 _rejected_<small>（代表失败）</small>。

```
pending 
├──> fulfilled
└──> rejected
```

Promise 对象的状态的变化只会发生一次，且不可逆。一旦 Promise 对象的状态一旦变为 2 种终止态中的任意一个，都称它为“**已定型<small>（resolved）</small>**”。

Promise 对象的使用分为 2 步：

1. 创建 Promise 对象，并同时指定一个规则，什么情况下这个 Promise 对象从初始态变为 fulfilled 状态，什么情况下它从初始态变为 rejected 状态。

  ```js
  let p = new Promise((resolve, reject) => {
    // ...
  
    if ( /* 条件随便写 ^_^ 根据你自己的逻辑来 */ ) {
      resolve();  // 一旦它被执行，则意味着 Promise 对象从初始态进入 fulfilled 状态。
    } else {
      reject();   // 一旦它被执行，则意味着 Promise 对象从初态进入 reject 状态。
    }
  });
  ```

2. 设置 Promise 对象，指定 2 个回调函数。一个在 Promise 对象变为 fulfilled 态时，被触发执行；另一个在 Promise 对象变为 reject 时，被触发执行。

  ```js
  p.then(() => {
      // 执行 Promise 的成功回调
  }, () => {
      // 执行 Promise 的失败回调
  })
  ```


`p.then(函数一, 函数二);` 也可以写成：

```js
p.then(函数一)
 .catch(函数二);
```


通过以上例子，我们应该<small>（或者需要知道）</small>以下基本概念<small>（只考虑 Promise 中为异步代码）</small>：

- Promise 是一个构造函数，使用 `new Promise` 创建实例。所以变量 p 引用的是创建出来的一个对象。

- Promise 构造函数有一个参数 **executor** ，它是一个函数，**在 Promise 创建实例的过程中就会被立即执行执行**。

- executor 函数有两个参数 **resolve** 、**reject** ，也都是函数。在 executor 执行的过程中，会触发 resolve、reject 的执行<small>（以上例子中为异步执行）</small>。

  * 当 resolve 函数被执行时，当前的 Promise 对象将变成 fulfilled 状态。

  * 当 reject 函数被执行时，当前的 Promise 对象将变成 rejected 状态。

- Promise 对象一但变成 fulfilled 状态或者 rejected 状态之后，它的两个回调<small>（中的某一个）</small>函数将会被放入微队列，未来将会被主线程取出执行。

  * 当 Promise 对象变成 fulfilled 状态，它的 then 回调将被放入微队列<small>（而 catch 回调将会被忽略）</small>。then 回调被传入的参数，就是当初被传入 resolve 函数的参数。

  * 当 Promise 对象变成 rejected 状态，它的 catch 回调将被放入微队列<small>（而 then 回调将会被忽略）</small>。catch 回调被传入的参数，就是当初被传入 reject 函数的参数。

---

**用 Promise 包装 JQuery 的 Ajax 请求：**

- api.js

  ```js
  import Vue from 'vue'

  export default {
    async function ajax(params) {
      return new Promise((resolve, reject) => {
          $.ajax({
              url: params?.url || '',
              type: params?.type || 'post',
              contentType: params?.contentType || 'application/x-www-form-urlencoded',
              data: params?.data || '',
              success(res) { resolve(res); },
              error(res) { reject(res); }
          });
      });
    }
  }
  ```

上述代码用到了一个 [[202207080757#链判断运算符|".?" 运算符]] 技巧。

-   调用

  ```js
  // 测试
  ajax({
    url: '/departments',
    type: "get",
  }).then((res) => {
    console.log(res);
  }).catch((res) => {
    console.log(res);
  });
  ```

