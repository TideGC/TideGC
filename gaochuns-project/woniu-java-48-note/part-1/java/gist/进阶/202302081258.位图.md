---
alias: 
  - 位图 
---

## 位图 

bitmap 在很多海量数据处理的情况下会用到。一些典型的情况包括数据过滤，数据位设置和统计等。它的引入和应用通常是考虑到海量数据的情况下，用普通的数组会超出数据保存的范围。使用这种位图的方式虽然不能在根本上解决海量数据处理的问题，但是在一定的数据范围内，它是一种有效的方法。

bitmap 在 Java 的 JDK 里有一个对应的实现：BitSet 。

### 1. 构造方法和汇总统计方法

````ad-cite
title: 构造方法
collapse: close

```java
public BitSet()
    创建一个新的 BitSet: 所有的位初始均为 false/0。

public BitSet(int nbits)
    创建一个 BitSet，初始大小足以显式表示索引范围在 0 到 nbits-1 的位。
    所有的位初始均为 false/0
```
````

````ad-cite
title: 汇总统计
collapse: close

size / length / isEmpty / cardinality

```java
 int size()
     返回此 BitSet 实际使用空间的位数:nbits

 int length()
     返回此 BitSet 的"true"的位数：BitSet 中最高设置位的索引加 1。

 boolean isEmpty()
     如果此 BitSet 中没有包含任何设置为 true 的位，则返回 ture。

 int cardinality()
     返回此 BitSet 中设置为 true 的位数。
```
````

````ad-cite
title: 示例
collapse: close

```java
BitSet bitSet = new BitSet();
log.info("{}", bitSet.size()); // 64
bitSet.set(9);
log.info("{}", bitSet.length()); // 9+1=10

BitSet bitSetNbit = new BitSet(1024);
log.info("{}", bitSetNbit.size()); // 1024
log.info("{}", bitSetNbit.length()); // 0
log.info("{}", bitSet.isEmpty()); // true
```
````

### 2. 基本位操作

````ad-cite
title: 清 0 / 置 1
collapse: close

-   set 方法是一个通用型的、清 0 / 置 1 方法：

    ```java
    void set(int bitIndex, boolean value)
        将指定索引 bitIndex 处的位设置为指定的 0/1 。

    void set(int fromIndex, int toIndex, boolean value)
        将指定的 [fromIndex, toIndex) 范围内的位设置为指定的 0/1 。
    ```

-   只有索引参数的 set 方法默认是置 1 

    ```java
    void set(int bitIndex)
        将指定索引 bitIndex 处的位设置为 1 。

    void set(int fromIndex, int toIndex)
        将指定的 [fromIndex, toIndex) 范围内的位设置为指定的 0/1 。
    ```

-   另外，BitMap 中有一个专门的 clear 方法是用来清 0 的

    ```java
    void clear()
        将此 BitSet 中的所有位设置为 false。

    void clear(int bitIndex)
        将索引指定处的位设置为 false。

    void clear(int fromIndex, int toIndex)
        将指定的 fromIndex（包括）到指定的 toIndex（不包括）范围内的位设置为 false。
    ```

-   批量清 0 与置 1

    ```java
    void andNot(BitSet set)
        逻辑上就是批量清 0 功能。对 this 中的某些位清 0 ，具体是哪些位取决于参数 set 。

    boolean intersects(BitSet set)
        逻辑上就是批量置 1 功能。对 this 中的某些置 1 ，具体是哪些位取决于参数 set 。
    ```
````

````ad-cite
title: 示例：清0和置1
collapse: close

- set 置 1

  ```java
  BitSet bitSet = new BitSet(1024);
  
  bitSet.set(0);              // [0] = 1/true
  bitSet.set(2);              // [2] = 1/true
  bitSet.set(4, true);        // [4] = 1/true
  bitSet.set(5, 7);           // [5] = 1/ture, [6] = 1/true
  bitSet.set(11, 12, false);  // [11] = 0/false
  
  // 输出索引位为 1/true 的元素的索引列表; 注意是{}不是[]
  log.info("{}", bitSet.toString()); // {0, 2, 4, 5, 6}
  
  // 容量
  log.info("{}", bitSet.size()); // 1024
  
  // 最后一个 1/true 的位的索引下标+1，即，
  // 从 0 下标开始到最后一个 1/true 下标位置（包括），有多少个元素（包括中间的 0/false）
  log.info("{}", bitSet.length()); // 7
  
  // 1/true 位的个数
  log.info("{}", bitSet.cardinality()); // 5
  ```

- set 清 0

  ```java
  BitSet bitSet = new BitSet(1024);
  
  bitSet.set(0);              // [0]=1
  bitSet.set(2);              // [2]=1
  bitSet.set(4, true);        // [4]=1
  bitSet.set(5, 7);           // [5,7)=1
  bitSet.set(11, 12, false);  // [11,12)=0
  
  bitSet.clear(2);            // [2]=0
  bitSet.clear(4, 6);         // [4,6)=0
  
  // 输出所有值为 1 的位的索引下标
  log.info("{}", bitSet.toString());  // {0, 6}
  log.info("{}", bitSet.size());      // 1024
  log.info("{}", bitSet.length());    // 截至到最后一个 1 ，总共有多少位
  log.info("{}", bitSet.cardinality()); // 所有值为 1 的位的个数
  ```

- clear 清 0

  ```java
  BitSet bitSet = new BitSet(1024);
  
  bitSet.set(0);              // [0]=1
  bitSet.set(2);              // [2]=1
  bitSet.set(4, true);        // [4]=1
  bitSet.set(5, 7);           // [5,7)=1
  bitSet.set(11, 12, false);  // [11,12)=0
  
  bitSet.clear(2);    // [2]=0
  bitSet.clear(4, 6); // [4,5)=0
  
  log.info("{}", bitSet.toString()); // {0, 6}
  log.info("{}", bitSet.size()); // 1024
  log.info("{}", bitSet.length()); // 7
  log.info("{}", bitSet.cardinality()); // 2
  ```
  ````

````ad-cite
title: 取反
collapse: close

```java
void flip(int bitIndex)
    将指定索引处的位设置为其当前值的反码。

void flip(int fromIndex, int toIndex)
    将指定的 [fromIndex, toIndex) 范围内的每个位设置为其当前值的反码。
```
````

````ad-cite
title: 示例：取反 
collapse: close

```java
BitSet bitSet = new BitSet(1024);

bitSet.set(0);              // [0]=1
bitSet.set(2);              // [2]=1
bitSet.set(4, true);        // [4]=1
bitSet.set(5, 7);           // [5,7)=1
bitSet.set(11, 12, false);  // [11,12)=false

bitSet.clear(2);    // [2]=0
bitSet.flip(2);     // 取反。[2]=1
bitSet.clear(4, 6); // [4,6)=0
bitSet.flip(4, 6);  // 取反。[4,6)=1

log.info("{}", bitSet.toString()); // {0, 2, 4, 5, 6}
log.info("{}", bitSet.length()); // 7
log.info("{}", bitSet.cardinality()); // 5
```
````

````ad-cite
title: 查值
collapse: close

有多种方法可以查值，不同的方法各有特色，用在不同的场景下。

```java
int nextClearBit(int fromIndex)
    从 fromindex 开始（含）, 查找第一个 0 ，返回其索引下标。

int nextSetBit(int fromIndex)
    从 fromIndex 开始（含），查找第一个 1，返回其下标索引。

boolean get(int bitIndex)
    返回 bitIndex 索引处的值。

String toString()
    返回此位 set 的字符串表示形式。
    // {2, 4, 10, 99}
```
````

````ad-cite
title: 示例：查值
collapse: close

```java
BitSet bitSet = new BitSet(1024);

bitSet.set(0); // [0]=1
bitSet.set(2); // [2]=1
bitSet.set(4, true); // 索引 4 = true :[4]=1

log.info("{}", bitSet.nextClearBit(2)); // 从索引 2 开始，第一个 0 的索引是 3
log.info("{}", bitSet.nextSetBit(2));   // 从索引 2 开始，第一个 1 的索引是 2 
log.info("{}", bitSet.get(2)); // true
log.info("{}", bitSet.get(3)); // false
```
````

````ad-cite
title: 与、或、异或
collapse: close

```java
void and(BitSet set)
    将 this 和参数 set 进行按位与操作。

void or(BitSet set)
    将 this 和参数 set 进行按位或操作。

void xor(BitSet set)
    将 this 和参数 set 进行按位亦或操作。

boolean equals(Object obj) // 比较两个 BitSet，规则是两者所有位的 0/1 要相同。
```
````
