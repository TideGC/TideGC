---
alias: 
- 认证成功返回 JSON String
tags: 
- spring-security
- jwt
- AuthenticationSuccessHandler
---

## 认证成功返回 JSON String

### 第 0 步：原理分析

在 spring-security 的 <mark style="background: #CACFD9A6;">formLogin()</mark> 配置中<small>（配置 **UsernamepasswordAuthenticationFilter**）</small>，它暴露出两个 Handler 配置，配合我们自定义 Handler 。

我们可以明确要求 spring-security 在登录认证成功时执行我们自定义的 **SuccessHandler** 的代码，而我们在这个代码中<small>（自定义的 **AuthenticationSuccessHandler** 的实现类）</small>，可以自己去编码"返回"一个 JSON 串。

所以为了实现 "认证成功返回 JSON String" 功能，我们需要自定义 Handler

```java
@Component  
public class SimpleAuthenticationSuccessHandler implements AuthenticationSuccessHandler {  
    …
}
```

并且进行配置 Handler

```java
http.formLogin()  
    .successHandler(successHandler)  
    …;
```

### 第 1 步：准备工作

[[202212221139.基本准备工作|《基本准备工作》]]

### 第 2 步：编写认证成功后的处理逻辑

用户所提供的 username/password 正确时，需要返回一个 JWT-Token 给用户：

```java
@Component
@RequiredArgsConstructor
public class SimpleAuthenticationSuccessHandler implements AuthenticationSuccessHandler {  
        
    private final ObjectMapper defaultMapper;  
        
    @Override 
    public void onAuthenticationSuccess(HttpServletRequest request, 
                                        HttpServletResponse response,  
                                        Authentication authentication) throws IOException, ServletException {  
        User user = (User) authentication.getPrincipal(); 

        String jwt = JwtUtils.createJWT(user.getUsername());

        ResponseResult<String> responseResult = new ResponseResult<>(200, "success", jwt);

        String jsonStr = defaultMapper.writeValueAsString(responseResult);

        response.setContentType(MediaType.APPLICATION_JSON_UTF8_VALUE);  
        response.getWriter().write(jsonStr);  
    }  

}
```

### 第 3 步：配置认证 SuccessHandler

```java
@RequiredArgsConstructor  
@EnableWebSecurity(debug = true)  
public class SecurityConfig extends WebSecurityConfigurerAdapter {  
      
    private final SimpleAuthenticationSuccessHandler successHandler;  
    private final SimpleAuthenticationFailureHandler failureHandler;  
    
    …
        
    @Override  
    protected void configure(HttpSecurity http) throws Exception {  
        http.formLogin()  
                .successHandler(successHandler)
                .permitAll();
                     
        http.csrf().disable();  
        http.httpBasic().disable();  
        http.sessionManagement()
            .sessionCreationPolicy(SessionCreationPolicy.STATELESS);  
    }  
          
  …
}
```

### 第 4 步：验证

```ini
## 成功  
POST http://127.0.0.1:8080/login  
Content-Type: application/x-www-form-urlencoded  

username=tommy&password=123456  
```



