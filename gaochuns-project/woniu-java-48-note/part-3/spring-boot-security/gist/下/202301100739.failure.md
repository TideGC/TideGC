---
alias: 认证失败返回 JSON String 
---

## 认证失败返回 JSON String 

### 第 0 步：原理分析

在 spring-security 的 <mark style="background: #CACFD9A6;">formLogin()</mark> 配置中<small>（配置 **UsernamepasswordAuthenticationFilter**）</small>，它暴露出两个 Handler 配置，配合我们自定义 Handler 。

我们可以明确要求 spring-security 在登录认证失败时执行我们自定义的 **FailureHandler** 的代码的执行，而在我们的 Handler 中我们会实现向前端返回 json-string 。

在这个代码中<small>（自定义的 **AuthenticationFailureHandler** 的实现类）</small>，我们可以自己去编码“返回”一个 JSON 串。

对此，我们需要自定义 Handler：

```java
@Component  
public class SimpleAuthenticationFailureHandler implements AuthenticationFailureHandler {  
    …
}
```

另外，我们需要去配置、去使用这个 Handler：

```java
http.formLogin()  
    .failureHandler(failureHandler)
    …;
```

### 第 1 步：准备工作

[[202212221139.基本准备工作|《基本准备工作》]]

### 第 2 步：编写认证失败后的处理逻辑

```java
@Component  
public class SimpleAuthenticationFailureHandler implements AuthenticationFailureHandler {  
      
    @Resource  
    private ObjectMapper defaultMapper;  
      
    @Override  
    public void onAuthenticationFailure(HttpServletRequest request,  
                                        HttpServletResponse response,  
                                        AuthenticationException exception) throws IOException, ServletException {  

        ResponseResult<Void> responseResult = new ResponseResult<>(400, "login failure");  

        String jsonStr = defaultMapper.writeValueAsString(responseResult);  

        response.setContentType(MediaType.APPLICATION_JSON_UTF8_VALUE);  
        response.getWriter().write(jsonStr);  
    }  
}
```

### 第 3 步：配置认证 FailureHandler

```java
@RequiredArgsConstructor  
@EnableWebSecurity(debug = true)  
public class SecurityConfig extends WebSecurityConfigurerAdapter {  
      
    private final SimpleAuthenticationSuccessHandler successHandler;  
    private final SimpleAuthenticationFailureHandler failureHandler;  
    
    …
        
    @Override  
    protected void configure(HttpSecurity http) throws Exception {  
        http.formLogin()  
                .failureHandler(failureHandler);  

        …
    }  

  …
}
```

### 第 4 步：验证

```ini
## 失败 
POST http://127.0.0.1:8080/login  
Content-Type: application/x-www-form-urlencoded  

username=ben&password=123
```

