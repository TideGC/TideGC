---
alias: RESTful 接口的幂等性
---


# RESTful 接口的幂等性

产生 "**重复数据或数据不一致**"<small>（ 假定程序业务代码没问题 ）</small>，绝大部分就是发生了重复的请求，重复请求是指"**同一个请求因为某些原因被多次提交**"。导致这个情况会有几种场景：

1. 微服务场景，在我们传统应用架构中调用接口，要么成功，要么失败。但是在微服务架构下，会有第三个情况『未知』，也就是超时。如果超时了，微服务框架会进行重试；

2. 用户交互的时候多次点击。如：快速点击按钮多次；

3. MQ 消息中间件，消息重复消费；

4. 第三方平台的接口<small>（如：支付成功回调接口）</small>，因为异常也会导致多次异步回调；

5. 其他中间件/应用服务根据自身的特性，也有可能进行重试。

接口的幂等性实际上就是『**接口可重复调用**』，在调用方多次调用的情况下，接口『**最终得到的结果是一致的**』。

> [!info] 
> - 以『增删改查』四大操作来看，『删除』和『查询』操作天然是幂等的，没有<small>（ 或不在乎 ）</small>重复提交/重复请求问题。因此，幂等需求通常是用在『新增』和『修改』类型的业务上。
> 
> - 而『修改』类型的业务通过 SQL 改造和 last_upated_at 字段的结合，也可以实现幂等，不强求必须使用我们这里的 token 和去重表方案。
> 
> - 因此，幂等性的处理重点集中在『新增』型业务上。

## 正常使用流程


### 第 1 步：获取幂等 token


![幂等-01](https://woniumd.oss-cn-hangzhou.aliyuncs.com/java/hemiao/20220627170735.png)


服务端提供了生成并发送 token 的接口。我们在分析业务的时候，哪些业务是存在幂等问题的，就必须在执行业务前，先去获取 token，服务器会把 token 保存到 redis 中。

需要注意的是：

1. 这个幂等 token 本质上就是一个字符串，但是它必须是具有唯一性的。例如，UUID 。

2. 这个幂等 token 要存取 redis 中。此时存入，是因为在未来需要再从 redis 中删除它。

### 第 2 步：正确使用幂等 token

![幂等-02](https://woniumd.oss-cn-hangzhou.aliyuncs.com/java/hemiao/20220627170738.png)

客户端在使用需要避免重复提交的 API 时，除了向后台提交正常的参数之外，**还需要额外提交之前所获得的幂等 token 。**

Controller 在调用 Service 层<small>（ 执行业务逻辑 ）</small>之前，需要从 redis 中将前一个功能中存入 redis 的幂等 token 删除。删除成功，才能继续向下执行。


## 非正常使用

![幂等-03](https://woniumd.oss-cn-hangzhou.aliyuncs.com/java/hemiao/20220627170740.png)

> [!warning]  
> 这里的删除操作，逻辑上起的是一个「判断」的作用：判断当前请求是否是合法的第一次请求。

这里的不合法的请求分为 3 种情况：

> [!dice-1] 非法情况一
> 没有经过上一步，因此，没有携带幂等 token；
> 
> 对于这种情况，因为缺少必要参数，所以 Controller 应该返回失败信息；

> [!dice-2] 非法情况二
> 携带了幂等 token，但是不是上一步生成、返回的。例如，是自己伪造的；
> 
> 对于这种情况，因为 redis 种没有这个伪造的幂等 token，所以会删除失败，因此，Controller 应该返回失败信息；

> [!dice-3] 非法情况三
> 携带的是合法的幂等token，但是是重复请求。
> 
> 对于这种情况，虽然 redis 中曾经有过这个幂等 token，但是因为已经被「用掉」了，所以，本次请求仍然应该返回失败信息。

## 其它：为什么不是查询判断

暂缺

## 其它：一个缺点

在上述方案中，我们是先删除 redis ，<small>删除成功后</small>，而后再执行业务逻辑代码。

这种方案有一个缺点：无论业务逻辑执行成功还是失败，redis 中的幂等 token 都被删除掉了，这是，用户如果需要重试，那么必须重新获得幂等 token 。

当然，你可以基于补偿的思维来改进这个方案：去 try-catch service 抛出的异常，一旦 service 执行失败，那么在 catch 代码块中再将幂等 token 重新存回 redis 。

