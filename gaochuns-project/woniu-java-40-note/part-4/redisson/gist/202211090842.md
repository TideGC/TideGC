---
alias: 问题三：Redis SETNX 有问题
---

## Redis SETNX 的问题

SETNX 命令的"解题思路"是完全正确的，但是 SETNX 命令本身是有缺陷的，从而导致它来解决并发问题，不完美。

上面的代码逻辑有 3 个问题：

1.  setnx 命令看起来是一条命令，好似应该是原子性的，但是它的底层是靠 set 和 expire 两条命令实现的。所以，它不是原子性的！这是最根本的毛病。

2.  上锁时，设置的超时自动删除时长<small>（ 3 秒 ）</small>，设置多长合适？万一设置短了怎么办?

    如果设置短了，在业务逻辑执行完之前时间到期，那么 Redis 自动就把键值对给删除了，即，把锁给释放了，这不符合逻辑。

3.  解锁时，`查 - 删` 操作是 2 个操作，由两个命令完成，非原子性。

当然，上述两个问题我们都能解决点，不过有人<small>（ Redisson ）</small>帮我们把这些事情做好了。

