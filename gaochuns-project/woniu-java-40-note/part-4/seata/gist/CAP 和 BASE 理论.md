---
alias: CAP 理论
---

# 理论

## CAP 理论

#cap

1998 年，加州大学的计算机科学家 Eric Brewer 提出，分布式系统有三个指标。

-tx-
| 指标 | 说明 |
| :- | :- |
|**C**onsistency（一致性） | all nodes see the same data at the same time |\
|                      | 在更新操作成功并返回客户端完成后，所有节点在同一个时间的数据完全一致。 |\
|                      | 这里的一致性是指强一致性。一般关系型数据库就具有强一致性特性。|
|**A**vailability（可用性）| Reads and writes always succeed  |\
|                      | 服务一直可用，而且是正常响应时间。|
|**P**artition tolerance （分区容错性）| the system continues to operate despite arbirary message loss or failure of part of the system |\
|                                  | 分布式系统在遇到某节点或网络分区故障时，仍然能够对外提供满足一致性和可用性的服务。 |

C、A、P 这 3 个要素的关系如图：

![CAP.png|500](https://woniumd.oss-cn-hangzhou.aliyuncs.com/java/hemiao/20220627173704.png)


Eric Brewer 指出，这三个指标不可能同时做到。这个结论就叫做 CAP 定理。由于 CAP 三需求无法同时满足，因此在设计分布式系统时就必须有所取舍。

由于网络并非 100% 可靠，因此分布式系统必须实现分区容错性，所以，系统架构师权衡取舍的也就只有 C<small>（ 一致性 ）</small>和 A<small>（ 可用性 ）</small>，即，CP 还是 AP 。

- 如果此时要保证**一致性**，就必须等待网络恢复，完成数据同步后，整个集群才对外提供服务，服务处于阻塞状态，不可用。
 
  CP ，即实现一致性和分区容错性。此组合为数据强一致性模式，即，要求在多服务之间数据一定要一致，弱化了可用性。一些对数据要求比较高的场景<small>（ 比如金融业务 ）</small>常使用此模式。这种模式性能较低。Seata AT 模式的 “读已提交” 级别就是这种模式。

- 如果此时要保证**可用性**，就不能等待网络恢复，那节点之间就会出现数据不一致。

  AP，即实现可用性和分区容错性。此组合为数据最终一致性，即，要求所有服务器都可用，弱化了一致性。互联网分布式服务多数基于 AP 。这种模式性能较高，可满足高并发业务需求。基于消息的最终一致性就是这种模式。

也就是说，在 P 一定会出现的情况下，A 和 C 之间只能实现一个。


## BASE 理论

BASE 理论是对 CAP 的一种解决思路，其核心思想是：无法做到强一致性，那么可以通过牺牲强一致性来获得可靠性。

BASE 理论包含三个思想：

- **B**asically **A**vailable<small>（基本可用）</small>：分布式系统在出现故障时，允许损失部分可用性，即保证核心可用。

- **S**oft State<small>（软状态）</small>：在一定时间内，允许出现中间状态，比如临时的不一致状态。

- **E**ventually Consistent<small>（最终一致性）</small>：虽然无法保证强一致性，但是在软状态结束后，最终达到数据一致。


BASE 是 Basically Available<small>（ 基本可用 ）</small>、Soft State<small>（ 软状态 ）</small>和 Eventually Consistency <small>（ 最终一致性 ）</small> 这 3 个短语的缩写。

BASE 理论是对 CAP 中的一致性及可用性进行权衡的结果，

1. Basically Available<small>（ 基本可用 ）</small>

  基本可用是对 A <small>（ 可用性 ）</small>的一个妥协，即在分布式系统出现不可预知故障时，允许损失部分可用性。比如在秒杀场景和雪崩的业务场景下进行降级处理，使核心功能可用，而不是所有的功能可用。

2. Soft State<small>（ 软状态 ）</small>

  软状态是相对于原子性而言的。<small>要求多个节点的数据副本是一致的，这是一种“硬状态”。</small>

  “软状态”指的是：允许系统中的数据存在中间状态，并人为该状态不影响系统的整体可用性，即允许系统在多个不同节点的数据副本上存在数据延时。

> [!cite] 提示
> 不只是分布式系统使用最终一致性，关系型数据库在某个功能上也使用最终一致性。比如在备份时，数据库的复制过程是需要时间的，在这个复制过程中，业务读取的值就是“旧”的。当然，最终还是达到了数据一致性。

总的来说，BASE 理论面向的是大型高可用、可扩展的分布式系统。不同于 ACID ，BASE 理论提出通过牺牲强一致性来获得可用性，并允许一定时间内的不一致，但最终达到一致。