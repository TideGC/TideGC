---
alias: Seata-AT 模式原理概述
---

## Seata-AT 模式原理概述

#seata #seata-at

AT 模式是 Seata 主推的分布式事务解决方案，对业务无入侵，真正做到了业务与事务分离，用户只需关注自己的业务 SQL 语句。

AT 模式本质上是两阶段提交协议的演变：

- 在第一阶段：业务数据和回滚日志记录在同一个本地事务中提交，释放本地锁和连接资源。

- 在第二阶段：

  - 提交异步化，非常快速地完成。
  - 回滚通过一阶段的回滚日志进行反向补偿。

AT 事务流程分为两个阶段，一阶段的主要流程如下：

| # | :- |
|-:| :- |
| 1| A 服务<small>（ 的 TM ）</small> 向 TC 申请开启一个全局事务，TC 返回一个全局事务 ID 。|
| 2| A 服务开启本地事务，生成 undo log，执行业务 SQL 语句，生成 redo log，保存 undo/redo log ，生成全局锁数据。|
| 3| 在 A 服务 提交本地事务之前，A 服务<small>（ 的 RM ）</small>会先向 TC 注册分支事务并申请全局锁。|
| 4| A 服务提交本地事务。|
| 5| A 服务<small>（ 的 RM ）</small>向 TC 上报事务状态。|
| 6| A 服务发起远程调用，把全局事务 ID 传给 B 服务。|
| 7| B 服务开启本地事务，生成 undo log ，执行业务 SQL 语句，生成 redo log，保存 undo/redo log，生成全局锁数据。|
| 8| 在 B 服务提交本地事务之前，B 服务<small>（ 的 RM ）</small>会先向 TC 注册分支事务并生成全局锁。|
| 9| B 服务提交本地事务。|
|10| B 服务<small>（ 的 RM ）</small>向 TC 上报事务状态。
|11| B 服务返回远程调用成功给 A 服务。
|12| A 服务<small>（ 的 TM ）</small>向 TC 申请全局事务的提交/回滚。

至此，一阶段处理完毕。

TC 在收到全局事务提交/回滚指令后发起二阶段处理：

- 如果是全局事务提交，则 TC 通知各个微服务<small>（ 的 RM ）</small>异步清理本地的事务日志。

- 如果是全局事务回滚，则 TC 通知各个微服务<small>（ 的 RM ）</small>回滚数据。

![|850](https://woniumd.oss-cn-hangzhou.aliyuncs.com/java/hemiao/20220728223029.png)
