---
alias: 发送者确认机制
tags: rabbitmq, spring-boot 
---

## 问题

- 你（发送者）有没有可能消息发丢了？
- 消息丢没丢你知不知道？
- 如果你知道消息罚丢了，你有没有什么补救措施？
- 什么样的补救措施，可以让消息最终还是能发到对方那边？


## 发送者确认机制

> [!warning] 注意
> 发送者如何知道自己所发送的消费成功抵达了 RabbitMQ Broker 中的 Exchange 中，乃至成功抵达了 RabbitMQ Broker 中的 Queue 中？
> 
> **生产者确认**

### 1. 问题一

故意向一个不存在的交换机发送消息，从人的视角上看，这代码是有逻辑问题的。

```java
rabbitTemplate.convertAndSend("hello", "world", "goodbye");
```

但是，如何在代码层面判断发送成功还是失败？

我们面对的问题在于：

1. convertAndSend 方法没有返回值，不存在什么 "发送成功返回 true，发送失败返回 false" 的问题。
2. convertAndSend 方法不会抛异常，成功过也好，失败也好和 try-catch 没关系。

### 2. 解决问题一：发送者确认机制

[[202208261907|确认消息已到 Exchange]]

### 3. 问题二

通过 RabbitTemplate 发送消息，发送多少个消息，回调方法就会被触发执行多少次。即，convertAndSend 执行多少次，confirm 回调方法就会被触发执行多少次。

但是，在多次发送中，怎么知道是哪一次的发送失败了。<small>因为后续，我们可能要考虑重发这条消息。</small>

简单来说，我们知道发送的方法和回调的方法一定是 1:1 的关系，但是，"哪个回调是那个发送的回调" 怎么确认？

### 4. 解决问题二：CorrelationData


### 5. 问题三

现在借助于 CorrelationData ，我们知道是哪一次的消息发送出了问题，现在，我们要引入重试机制。

对于重试，我们一些要求和想法：

1. 需要有重试。

2. "发送失败后，立刻重试" 价值不大，因为，大概率仍会失败<small>（造成上次失败的原因可能还存在）</small>。

3. 失败后，要重试，但是不会无休止的重试。因为在代码无 bug 的情况下，消息发布到交换机本来就是小概率事件的极端情况，现在它接二连三地出现，就一定意味着现实场景中哪里出问题了，这种情况下再反复重试也没有什么意义了。

4. 为了配合作为"兜底"方案的：人工干预，我们必须得知道哪些消息是经过重试后都一直没有发送成功（到交换机）的，只有这样，"人" 才知道他要手动处理哪些消息。

### 6. 解决问题三：定时任务 + 消息发送表 












---

### 其它

[[202208261904|确认消息已到 Message Queue]]

