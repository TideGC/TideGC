Alibaba Nacos 是阿里公司开源的一款 [[202207270723|注册中心]] ，是 [[202207262304|Spring Cloud]] 的上一代注册中心 Eureka 的替代品。

在 [[202207270741|安装]] 了 Alibaba Nacos 之后，通过使用它，我们就有办法来解决我们的 [[woniu-java-40-note/part-4/微服务/gist/问题二|问题二]] 。

## 被调用方（员工项目）的改造工作

### 第 1 步：为项目新增 nacos 注册中心依赖

稳妥起见，最好是从 [阿里云脚手架](https://start.aliyun.com/bootstrap.html) 上复制粘贴所需内容。

![](https://woniumd.oss-cn-hangzhou.aliyuncs.com/java/hemiao/20220921141021.png)

不出意外，pom.xml 中多出来这么 3 个东西<small>（ 其实本质上就是为了引入一个依赖包 ）</small>

```xml
  
<properties>
    ......
    <spring-cloud-alibaba.version>2.2.2.RELEASE</spring-cloud-alibaba.version>   <!-- 1 版本号定义 -->
</properties>  

<dependencies>  
    ......
    <dependency>  <!-- 2 依赖包 -->
        <groupId>com.alibaba.cloud</groupId>  
        <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>  
    </dependency>
</dependencies>  
  
<dependencyManagement>  
    <dependencies>  
        ......
        <dependency> <!-- 3 导入alibaba官方的 dependencyManagement -->
            <groupId>com.alibaba.cloud</groupId>  
            <artifactId>spring-cloud-alibaba-dependencies</artifactId>  
            <version>${spring-cloud-alibaba.version}</version>  
            <type>pom</type>  
            <scope>import</scope>  
        </dependency>  
    </dependencies>  
</dependencyManagement>
```

### 第 2 步：添加 nacos 注册中心配置

如果你通过 [阿里云脚手架](https://start.aliyun.com/bootstrap.html) 创建项目，那么你从阿里云脚手架上下载下来的项目"架子"中就已经有了 nacos 注册中心的配置：

- 你的项目中会有一个"多"出来一个配置类：

![](https://woniumd.oss-cn-hangzhou.aliyuncs.com/java/hemiao/20220921152657.png)

而且，你的 Spring Boot 项目的配置文件 application.properties 中也会"多"出来一段 nacos 配置：

![](https://woniumd.oss-cn-hangzhou.aliyuncs.com/java/hemiao/20220921152904.png)

上面的 4 项配置项，根据你的具体情况进行调整。
- server-addr 100% 是要修改的；
- namespace 可能会改动；
- username 和 password 改动可能性不大。

### 第 3 步：验证

修改完毕之后，重启部门 Spring Boot 项目，访问 Nacos Server ，理应在 Nacos Server 上看到部门 Spring Boot 项目的相关信息。

## 调用方（部门）的改造工作

### 第 1 步：为项目新增 nacos 注册中心依赖

略。

参看上面 "被调方改造工作" 的 "第 1 步" 。

为项目添加 *spring-cloud-starter-alibaba-nacos-discovery* 依赖。

### 第 2 步：添加 nacos 注册中心配置

略。

参看上面 "被调方改造工作" 的 "第 2 步" 。

为项目添加所要连接到的 nacos-server 的相关信息。

### 第 3 步：为 RestTemplate 添加 @LoadBalanced 注解

```java
@Bean
@LoadBalanced  
public RestTemplate restTemplate() {  
    return new RestTemplate();  
}
```

### 第 4 步：修改 Service 中 RestTemplate 发送 HTTP 请求的代码

```java
@Resource  
private EmployeeDao employeeDao;  
  
@Resource  
private RestTemplate restTemplate;  
  
public Employee getEmployeeById(Long id) {  
    Employee employee = employeeDao.selectById(id);  
    // 被调方的 "ip:port" 被替换成了它在 nacos-server 上所注册的服务名
    Department department = restTemplate.getForObject("http://department-service/department?id=" + id, Department.class);  
    employee.setDepartment(department);  
    return employee;  
}
```

### 第 5 步：重启员工 Spring Boot 项目，验证

- 验证 Nacos Server 上能看到员工 Spring Boot 项目，略；
- 验证代码逻辑正确，略。