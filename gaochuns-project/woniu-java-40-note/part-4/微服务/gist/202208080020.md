## Eureka 的自我保护与健康检查 

tags: #spring-cloud #eureka 

在 Eureka Server 的各个服务的 Status 栏显示着 **UP** ，表示该服务及其多实例处于状态正常。其它取值 **DOWN** 、**OUT_OF_SERVICE** 、**UNKNOWN** 等均表示该服务处于不可被请求的状态，只有 **UP** 状态的微服务会被请求。

Eureka Server 与 Eureka Client 之间使用『**心跳机制**』来确定Eureka Client（微服务实例）的状态。

### 心跳配置

在 Eureka Client 端，有 2 个配置与这个『心跳机制』有关：

```yaml
# Eureka Client 配置
eureka:
  instance:
    lease-renewal-interval-in-seconds: 30 # 默认值
    lease-expiration-duration-in-seconds: 90 # 默认值
```

- **lease-renewal-interval-in-seconds** ：表示每间隔 N 秒，Client 向 Server 发送一次心跳，以证明自己<small>（Client）</small>还存活。

- **lease-expiration-duration-in-seconds** ：是 Client 端告知 Server，如果<small>（未来）</small>我<small>（Client）</small>在连续的 N 秒内没有给你<small>（Server）</small>发心跳，就代表我<small>（Client）</small>「死」了，请你<small>（Server）</small>将我<small>（Client）</small>踢除。


### 清理失联实例

Eureka Client 通过心跳机制向 Eureka Server 证明自己的存活状态，但是，一旦 Eureka Client 挂掉了，超过了 Client 自己所声明的最长上报时间，Eureka Server 也不是实时将其移除。

Eureka Server 每间隔一段时间『集中』清理无效的客户端，这个配置是 Server 端的：

```yaml
# Eureka Server 配置
eureka:
  server:
    eviction-interval-timer-in-ms: 60000 # 默认值，单位毫秒
```


### 注册中心自己掉线

Eureka Server 发现 Client 没给它<small>（Server）</small>发送心跳，不一定是 Client 出现了问题，也有可能是 Eureka Server 自己掉线了。

默认情况下，如果在 **15** 分钟内超过 **85%** 的客户端节点都没有正常的心跳，那么 Eureka 就认为这些客户端与注册中心出现了网络故障<small>（比如网络故障或频繁的启动关闭客户端）</small>，Eureka Server自动进入『**自我保护模式**』。

和这个概念有关的配置是：

```yaml
# Eureka Server 配置
eureka:
  server:
    enable-self-preservation: true
    renewal-threshold-update-interval-ms: 15 * 60 * 1000
    renewal-percent-threshold: 0.85
```

Eureka Server 一旦认为是自己出了问题，从而开启保护模式后，就不再将失效的服务从列表中剔除。当网络故障恢复后，Eureka Server 会自动退出自我保护模式。

在开发和测试环境中，由于我们会经常性地、频繁地启停服务，导致心跳消失，因此我们通常会将 Eureka Server 的『**自我保护模式**』关闭掉，以避免它触发进入保护模式，从而导致改下线的服务没有下线。

关闭自我保护模式，需要在服务端和客户端配置：

```yaml
# 服务端配置
# 1. 关闭自我保护模式。（新版本中官方不建议关闭，会有告警）
# 2. 缩短清理周期。（其实默认值也行）
eureka:
  server:
    enable-self-preservation: false 
    eviction-interval-timer-in-ms: 60000

# 客户端配置：
# 1. 缩短心跳上报周期
# 2. 缩短有效期时长
eureka:
  instance:
    lease-renewal-interval-in-seconds: 4
    lease-expiration-duration-in-seconds: 12
```

