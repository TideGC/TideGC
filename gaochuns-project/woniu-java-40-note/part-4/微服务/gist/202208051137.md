## zuul 实现服务拦截 

tags: #spring-cloud #zuul

前面我们提到，服务网关还有个作用就是接口的安全性校验，这个时候我们就需要通过 zuul 进行统一拦截，zuul 通过继承过滤器 **ZuulFilter** 进行处理，下面请看具体用法。 

新建一个类 ***ApiFilter*** 并继承 ***ZuulFilter***：

```java
@Component
public class ApiFilter extends ZuulFilter {

  @Override
  public String filterType() {
    return FilterConstants.PRE_TYPE;
  }

  @Override
  public int filterOrder() {
    return 0;
  }

  @Override
  public boolean shouldFilter() {
    return true;
  }

  @Override
  public Object run() throws ZuulException {
    // 这里写校验代码。例如 JWT 的校验。
    RequestContext context = RequestContext.getCurrentContext();
    HttpServletRequest request = context.getRequest();
    HttpServletResponse response = context.getResponse();
    response.setCharacterEncoding("UTF-8");
    response.setHeader("Content-type","text/html;charset=UTF-8");

    log.info("请求进入过滤器，访问的 url：{}，访问的方法：{}", 
                request.getRequestURL(), 
                request.getMethod());

    // 根据需要获取请求中的参数
    String token = request.getParameter("token");

    int random = (int) (Math.random() * 100);

    if (random % 2 == 0) {
      log.info("请求不通过过滤器");
      try {
        response.getWriter().write("token is invalid.");
      } catch (Exception e) {
        e.printStackTrace();
      }

      // 根据业务逻辑，本次请求就『到此为止』，不要再向下传递了。
      context.setSendZuulResponse(false);
      context.setResponseStatusCode(200);
    }
    else {
      log.info("请求通过过滤器");
    }

    return null;
  }
}
```

其中:

- **filterType** 为过滤类型，可选值有 

    - pre：在 Zuul 按照规则路由到下级服务之前执行。如果需要对请求进行预处理，比如鉴权、限流等，都应该考虑在此类 Filter 中实现。
    - route：这类 Filter 是 Zuul 路由动作的执行者。<small>我们通常不会实现这类路由。</small>
    - post：这类 Filter 是在源服务返回结果或者异常信息发生后执行的，如果需要对返回信息做一些处理，则在此类 Filter 进行处理。
    - error：在整个路由环节中如果发生异常，则会进入 error Filter，可做全局异常处理。

- **filterOrdery** 为过滤的顺序，如果有多个过滤器，则数字越小越先执行

- **shouldFilter** 表示是否过滤。它的返回值决定了该 Filter 是否执行，可以作为开关来使用。<small>不过，通常它都是返回 true，『开关』的问题有专门的配置项进行配置。</small>

- **run** 为过滤器执行的具体逻辑，在这里可以做很多事情，比如:权限判断、合法性校验等。

启动 gateway，在浏览器输入地址: [http://localhost:8080/api/hello](http://localhost:8080/api/hello)，可以看到以下界面：

```
token is invalid
```

再通过浏览器输入地址: [http://localhost:8080/api/index?token=12345](http://localhost:8080/api/index?token=12345)，可以看到以下界面:

```
端口: 8762
```

