---
alias: ['Gateway 网关解决"问题五"']
tags: gateway
---

## Gateway 网关解决"问题五"

[[202207271223|关于网关]]

### 源码示例

- https://e.coding.net/hemiao/code-sample/spring-cloud-examples.git 中的 spring-cloud-gateway-sample-0

### 前置条件

- 本地存在 MySQL 数据库；

- 本地存在 nacos-server 注册中心；

- 本地存在 department-service 服务，对外暴露 `GET /departments/get` URI ；

- 本地存在 employee-service 服务，对外暴露 `GET /employees/get` URI 。

### 第 1 步：引入 pom 依赖包

创建 gateway-service 项目。<small>相较于之前的、普通的 spring-boot 项目，其中会多出来 3 样东西：</small>

```xml
<properties>  
    <spring-cloud.version>Hoxton.SR9</spring-cloud.version>  
    ...
</properties>

<dependencies>  
    <dependency>  
        <groupId>org.springframework.cloud</groupId>  
        <artifactId>spring-cloud-starter-gateway</artifactId>  
    </dependency>  
    ...
</dependencies>

<dependencyManagement>  
    <dependencies>  
        <dependency>  
            <groupId>org.springframework.cloud</groupId>  
            <artifactId>spring-cloud-dependencies</artifactId>  
            <version>${spring-cloud.version}</version>  
            <type>pom</type>  
            <scope>import</scope>  
        </dependency>  
        ...
    </dependencies>  
</dependencyManagement>
```

### 第 2 步：在配置文件中添加配置信息

```properties
server.port=10000
spring.application.name=gateway-service
## Gateway
spring.cloud.gateway.routes[0].id=department-service-route
spring.cloud.gateway.routes[0].uri=lb://department-service
spring.cloud.gateway.routes[0].predicates[0]=Path=/department-service/**
spring.cloud.gateway.routes[0].filters[0]=RewritePath=/department-service/(?<segment>.*), /${segment}
spring.cloud.gateway.routes[1].id=employee-service-route
spring.cloud.gateway.routes[1].uri=lb://employee-service
spring.cloud.gateway.routes[1].predicates[0]=Path=/employee-service/**
spring.cloud.gateway.routes[1].filters[0]=RewritePath=/employee-service/(?<segment>.*), /${segment}
```


> [!info] 提示
> Path 断言不会改变请求的 URI ，整个过程中只有 IP、端口部分会被"替换"掉 。


### 第 3 步：学习 Ribbon 在背后的支持

> 了解

因为包传递 Gateway 包会自动引入 Ribbon ，Gateway 用到了 Ribbon 。

### 第 4 步：学习 RewritePath 过滤器

> 了解

RewritePath 过滤器可以重写 URI，去掉 URI 中的前缀。例如，下面的自己中就是去掉所有 URI 中的 **/xxx/yyy/zzz** 部分，只留之后的内容，再进行转发。

对于请求路径 "/xxx/yyy/zzz/hello" ，当前的配置在请求到到达前会被重写为 /hello ，

- **命名分组**

```
(?<name>正则表达式)
```

与普通分组一样的功能，并且将匹配的子字符串捕获到一个组名称或编号名称中。在获得匹配结果时，可通过分组名进行获取。

`(?<segment>.*)`：匹配 0 个或多个任意字符，并将匹配的结果捕获到名称为 segment 的组中。

- **引用捕获文本**

```
${name}
```

将名称为 name 的命名分组所匹配到的文本内容替换到此处。

`$\{segment}`：将前面捕获到 segment 中的文本置换到此处，注意，\ 的出现是由于避免 YAML 认为这是一个变量而使用的转义字符。

### 第 5 步：验证

向网关发送请求，看是否能触发 department-serivce 和 employee-service 的代码的执行，看从网关处是否能获得 department-service 和 employee-service 的返回：

```ini
###  
GET http://localhost:10000/department-service/departments/get?id=1  
  
###  
GET http://localhost:10000/employee-service/employees/get?id=1
```

> [!cite] 补充
> 如果你启动了多个服务提供者实例，Gateway 会自动实现基于轮循的负载均衡路由。
 
### 第 6 步：改进

#### 第 1 步：网关注册到 nacos-server

```properties
spring.cloud.nacos.discovery.server-addr=127.0.0.1:8848
spring.cloud.nacos.discovery.username=nacos
spring.cloud.nacos.discovery.password=nacos
spring.cloud.nacos.discovery.namespace=
spring.cloud.nacos.discovery.group=DEFAULT_GROUP
```

#### 第 2 步：网关借助 nacos-server 简化路由配置

```properties
# 启用 Gateway 和网关的整合
spring.cloud.gateway.discovery.locator.enabled=true
# 降低日志级别，验证配置
logging.level.org.springframework.cloud.gateway=DEBUG
```

#### 第 3 步：去掉老配置

```properties
spring.cloud.gateway.routes[n].xxx=... # 全部删除
```

### 第 8 步：再验证

略


