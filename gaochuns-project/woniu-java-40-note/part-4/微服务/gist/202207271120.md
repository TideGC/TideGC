## Sentinel 的底层工作流程

tags: #spring-cloud #spring-cloud-alibaba #sentinel 

Spring Cloud Alibaba Sentinel 的底层工作流程伪代码如下：

```text
1. 初始化上下文;
try {
  2. 熔断、流控逻辑的判断，判断当前请求是否能继续执行;
  3. 执行「真·代码」;
} catch (BlockException e) {
  4. 上述第 2 步未能通过，会抛出 BlockException ，表示请求被拒绝
  return;
} catch (Exception e) {
  5. 业务异常，记录、统计异常信息
  throw e;
} finally {
  6. 收尾工作：曾经创建的资源该回收的回收，该清除的清除
}
```

> [!cite] 提示
> 仔细回想一下，上述的代码执行流程非常类似于 JDBC 和 Spring AOP 环绕通知（ @Around ）的 try-catch-finally 流程。

如果上述伪代码的真实情况如下：

```java
ContextUtil.enter("上下文名称，例如：sentinel_spring_web_context");
Entry entry = null;
try {
    entry = SphU.entry("资源名称，例如：/rpc/openfein/demo", EntryType.IN or EntryType.OUT ); // 这背后有一个 Slot 链
    return doBusiness(); // 这里是执行业务方法，被 Sentinel「保护」起来了
} catch (Exception e) {
    if (!(e instanceof BlockException)) Tracer.trace(e);  // 记录调用异常
    throw e;
} finally {
    if (entry != null) entry.exit(1); // 收尾工作：曾经创建的资源该回收的回收，该清除的清除
    ContextUtil.exit();
}
```

