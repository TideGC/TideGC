---
Spring Boot 文件上传
---

# Spring Boot 文件上传


## 基本实现

在 Spring Boot 中实现文件上传本质上就是使用 Spring MVC 进行文件上传。细小之处的区别有 2 个：

1. 由于 Spring Boot 使用的内嵌的 Tomcat 的版本要远高于 tomcat 7，所以，之前 Servlet 3.1 中的 StandardMultipartResolver 编码问题就不再是问题了。
2. 如果使用 Servlet 3.1 的上传功能，相关配置现在就要写在配置文件中，而不是 web.xml 中了。


- 配置文件：

  ``` yml
  spring:
    servlet:
      multipart:
        enabled: true   # 是否开启文件上传功能。默认值为 true
        file-size-threshold: 100KB   # 临时存盘阈值。超过这个大小的上传文件会先写入临时磁盘目录，否则就是存在内存中。 默认值为 0，单位为“MB”或者“KB”
        max-file-size: 1MB # 单个文件的最大值，默认值1MB
        max-request-size: 10MB # 上传文件总的最大值，默认10MB
  ```

- thymeleaf 页面：

  ```html
  <form th:action="@{/upload}" method="post" enctype="multipart/form-data">
    <p><input type="text" multiple name="username"></p>
    <p><input type="text" name="password"></p>
    <p><input type="file" name="files"></p>
    <p><input type="file" name="files"></p>
    <p><button type="submit">提交</button></p>
  </form>
  ```

- Controller 代码：

  ```java
  @RequestMapping("/upload")
  public String upload(String username,
                       String password,
                       @RequestPart("files") MultipartFile[] files) {
    System.out.println(username);
    System.out.println(password);
    Arrays.stream(files).forEach((file) -> System.out.println(file.getOriginalFilename()));
  
    return "success";
  }
  ```





## AJAX 异步请求中的文件上传

> 我们使用 axios 发起 AJAX 异步请求。

在 AJAX 中发起文件上传请求的关键在于要去设置请求头的 **Content-Type: multipart/form-data** 。

> [!tip]
> 在普通的表单提交中，由于我们设置了表单元素的 enctype，帮我们设置了 HTTP 请求的请求头。

- HTTP 页面

  ```js
  <form>
    <p><input type="text" name="username"></p>
    <p><input type="text" name="password"></p>
    <p><input id="inputElement" type="file" multiple name="files"></p>
    <p><input id="inputElement1" type="file" name="files"></p>
    <!--    <p><button type="submit">提交</button></p>-->
    <p>
        <button type="button" onclick="btnClickHandler()">提交</button>
    </p>
  </form>
  ```

- JavaScript 代码

  ```js
  function btnClickHandler() {
    let inputElement = document.getElementById("inputElement");
    let inputElement1 = document.getElementById("inputElement1");

    let param = new FormData(); // 创建 form 对象

    Array.from(inputElement.files).forEach((item) => {
      param.append("files", item); // 通过 append 向 form 对象添加数据
    });

    Array.from(inputElement1.files).forEach((item) => {
      param.append("files", item);
    });

    param.append("username", "tommy"); // 添加 form 表单中其他数据
      param.append("password", "123456");

    let config = {
      headers: {"Content-Type": "multipart/form-data"}
    };

    axios.post("/upload", param, config)
      .then(res => {
        console.info(res.data);
      }).catch(err => {
        console.error(err);
    });
  }
  ```

- 获得上传进度

  axios 有的方案获得上传进度：onUploadProgress 。

  ```js
  let config = {
    headers: {"Content-Type": "multipart/form-data"},
    onUploadProgress (progress) {
      console.log(Math.round(progress.loaded / progress.total * 100) + '%');
    }
  };
  ```

  在文件的上传过程中，axios 会反复调用回调函数 onUploadProgress，并将已上传数据量和总数据量传入到回调函数中以供使用。

