links: [[mybatis-plus-all-in-one]]

# 增删改

```yaml
mybatis-plus:
  configuration:
    log-impl: org.apache.ibatis.logging.stdout.StdOutImp
  global-config:
    banner: false

```

## 1. 普通增删改 

- Insert

  ```java
  /** 
  * 插入一条记录
  *
  * 参数 entity：实体对象
  */
  int insert(T entity);
  ```

- Delete

  ```java
  /** 
  * 根据 entity 条件，删除记录
  * 
  * 参数	wrapper：实体对象封装操作类（ 可以为 null ）
  */
  int delete(@Param(Constants.WRAPPER) Wrapper<T> wrapper);

  /** 
  * 删除（ 根据 ID 批量删除 ）
  * 
  * 参数 idList：主键 ID 列表（ 不能为 null 以及 empty ）
  */
  int deleteBatchIds(@Param(Constants.COLLECTION) Collection<? extends Serializable> idList);

  /** 
  * 根据 ID 删除
  *
  * 参数 id：主键 ID
  */
  int deleteById(Serializable id);

  /**
  * 根据 columnMap 条件，删除记录
  *
  * 参数 columnMap：表字段 map 对象
  */
  int deleteByMap(@Param(Constants.COLUMN_MAP) Map<String, Object> columnMap);
  ```

- Update

  ```java
  /**
  * 根据 whereWrapper 条件，更新记录
  * 
  * 参数 entity：实体对象 ( set 条件值，可为 null )
  * 参数 updateWrapper：实体对象封装操作类（ 可以为 null，里面的 entity 用于生成 where 语句 ）
  */
  int update(@Param(Constants.ENTITY) T updateEntity, 
            @Param(Constants.WRAPPER) Wrapper<T> whereWrapper);

  /** 
  * 根据 ID 修改
  *
  * 参数 entity：实体对象（ set 条件值，可为 null ）
  */
  int updateById(@Param(Constants.ENTITY) T entity);
  ```

## 2. insert ID 主键回填

insert 后主键会自动 set 到实体的 ID 字段，所以你只需要 `getId()` 就好。


## 3. 条件删除：使用 Wrapper

我们「心里」期望执行的 SQL 如下：

``` sql
DELETE FROM  department WHERE  name = 'test'; 
```

使用 Wrapper 对应 Java 中的实现如下：

```java
Wrapper<Department> wrapper = new QueryWrapper<Department>().eq("name", "test");
departmentDao.delete(wrapper);
```


## 4. 条件修改：使用 Wrapper

我们『心里』期望执行的 SQL 如下：

``` sql
update
    department
set name     = 'hello-new',
    location = 'world'
where 
    name = 'hello';
```

使用 Wrapper 对应 Java 中的实现如下：

```java
Department department = new Department(null, "hello-new", "world");
Wrapper<Department> wrapper = new QueryWrapper<Department>()
        .eq("name", "hello");

departmentDao.update(department, wrapper);
```

::: warning 注意
这里的 null 值表示保持原址不变。
:::



## 5. 插入或更新的字段有空字符串或 null

方式有三种，最新、也是最灵活的是使用 **UpdateWrapper** 。它需要 mybatis-pulus 在 3.0+ 。 

使用以下方法来进行更新或插入操作：

```java
//updateAllColumnById(entity) // 全部字段更新: 3.0已经移除
mapper.update(
   new User().setName("mp").setAge(3),
   Wrappers.<User>lambdaUpdate()
           .set(User::getEmail, null) //把email设置成null
           .eq(User::getId, 2)
);
```

也可以参考下面这种写法：

```java
mapper.update(
    null,
    Wrappers.<User>lambdaUpdate()
       .set(User::getAge, 3)
       .set(User::getName, "mp")
       .set(User::getEmail, null) //把email设置成null
       .eq(User::getId, 2)
);
```


## 6. 逻辑删除

- **步骤 1**：配置 com.baomidou.mybatisplus.core.config.GlobalConfig$DbConfig。

  ``` yml
  mybatis-plus:
    global-config:
      db-config:
        logic-delete-field: flag  ### 全局逻辑删除的实体字段名(since 3.3.0,配置后可以忽略不配置步骤 2)
        logic-delete-value: 1 ### 逻辑已删除值(默认为 1)
        logic-not-delete-value: 0 ### 逻辑未删除值(默认为 0)
  ```

- **步骤 2**：加上注解。

  ```java
  @TableLogic
  private Integer deleted;
  ```

## 7. 乐观锁

```java
@Bean
public MybatisPlusInterceptor mybatisPlusInterceptor() {
    MybatisPlusInterceptor interceptor = new MybatisPlusInterceptor();
    interceptor.addInnerInterceptor(new OptimisticLockerInnerInterceptor());
    return interceptor;
}
```

在实体类的字段上加上 **@Version** 注解：

```java
@Version
private Integer version;
```

> [!warning]  在使用 MP 乐观锁功能的时候，记得在你的 update 功能中，为你的 PO 类的 version 字段赋值。这样，你才能在 MP 执行的 SQL 语句中看到客观锁逻辑。


