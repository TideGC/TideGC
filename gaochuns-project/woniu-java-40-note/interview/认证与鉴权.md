我们项目的认证和鉴权功能的实现是由我负责的。

## 独立微服务进行认证 

/login 请求在经过网关时会被网关放行，并转给我专门的认证微服务。

我实现的认证微服务本来可以不需要使用 spring-security 的，因为它仅仅就只是实现登录认证功能，而不用实现鉴权功能，所以，理论上来说，也不是非用 spring-security 不可。

不过，我们公司之前的项目用 spring-security 还比较多，大家在 spring-security 这一块还是有一定的技术积累的，所以，最终也是同意我在认证服务这里直接就是用 spring-security 了。

借助于 spring-security ，整个认证的实现比较直接，靠 spring-security 的 UsernamePasswordAuthenticationFitler 和 UserDetialsService 来校验用户名和密码的正确性。

在自定义的 AuthenticationSuccessHandler 中生成 JWT-Token 并返回。

在登录认证成功后，除了返回 JWT-Token 之外，我还将其它的一些信息存到了 Redis 中，来为后续的鉴权及其它功能做铺垫。

这里存到 Redis 中的信息有：JWT-Token、当前登录的用户所具有的所有的身份和权限。

---

另外，在认证微服务中，我们还有一个挺重要的功能，为未来在网关处进行的鉴权工作准备"比对数据"。

我的认证微服务中除了正常的 RBAC 相关的权限表和用户表，还有一张路径权限表。记录的是各个微服务的 URI 所必要的访问权限。

并且，我利用了 spring-boot 项目的事件监听机制，在认证服务启动的时候从数据库中读取这个路径权限表，将各个路径及其必要的访问权限也存到了 Redis 中。

这样在后续的网关处的鉴权功能里面，我就直接从 Redis 中读取这些信息了。

## 网关处进行鉴权

关于鉴权，我是在 Gateway 网关处统一鉴权的。

请求走到 Gateway 网关时，我会先以删除的方式来判断 Redis 中是否有这个 JWT-Token ，如果删除操作返回 true ，那么就意味着用户陈工登录过，JWT-Token 合法，且还在同一个会话中，"距离"上次操作时间不久。

如果删除操作返回 false ，那么要么就是 JWT-Token 是非法的，要么就意味着用户"太久"没操作了，这里就返回信息要求用户重新登录。

其实这里还有一个操作可以做，不过我们没有去做进一步的要求，就是可以判断下 JWT-Token 是否是合法的，结合上一步的判断，如果 JWT-Token 是合法的，但是 Redis 中没有，那就意味着用户是曾经登录过的，但是长时间没操作，或者是被另一个登录"挤下线"了。否则，JWT-Token 非法，Redis 中也没有那么就意味着用户从来没有登录过，JWT-Token 是伪造的。以为我们项目没有区分这两种情况，所以代码层面我就也就没有去实现这一部分。

关于 JWT-Token 合不合法的问题，还有一种情况，就是有可能请求中根本就没有携带 JWT-Token 。在我们项目的设计中，我们人为约定，如果请求没有携带 JWT-Token 那就意味着它是想访问一个 permitted-all 的 URI 。对于这种 URI ，我们前面的路径权限表中是不去记录它的。返回来说的话，也就是如果一个访问路径是在路径权限表中没有的，在认证鉴权的逻集中我们认为它就是无权限要求的。不携带 JWT-Token 的时候就只能访问这种路径。

在 JWT-Token 通过了合法性验证之后才是鉴权逻辑。因为 JWT-Token 的 payload 部分存了用户的用户名和 ID ，所以，从 JWT-Token 中拿到用户 ID 之后可以从 Redis 中去查这个人所具有的权限。

另外，通过当前请求所要访问路径，去 Redis 中查询这个路径的所必要的访问权限。

最后对比当前用户所具有的权限，和 URI 路径所需的访问权限，如果 URI 的要求权限在用户的所具有的权限当中，那就放行请求。否则，就返回 "无权限" 信息。

