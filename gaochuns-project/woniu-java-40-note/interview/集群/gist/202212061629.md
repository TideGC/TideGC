---
alias: 关于 Redis 主从集群
tags: redis, 集群
---

## 关于 Redis 主从集群

主从同步<small>（也叫主从复制）</small>是 Redis 高可用服务的基石，也是多机运行中最基础的一个。我们把主要存储数据的节点叫做主节点<small>（master）</small>，把其他通过复制主节点数据的副本节点叫做从节点<small>（slave）</small>，如下图所示：

![redis-master-slaver-01.png|300](https://woniumd.oss-cn-hangzhou.aliyuncs.com/java/hemiao/20220627170657.png)

在 Redis 中一个主节点可以拥有多个从节点，一个从节点也可以是其他服务器的主节点，如下图所示：

![redis-master-slaver-02.png|300](https://woniumd.oss-cn-hangzhou.aliyuncs.com/java/hemiao/20220627170659.png)

主从同步具有以下三个优点：

- 性能方面：有了主从同步之后，可以把查询任务分配给从服务器，用主服务器来执行写操作，这样极大的提高了程序运行的效率，把所有压力分摊到各个服务器了；

- 高可用：当有了主从同步之后，当主服务器节点宕机之后，可以很迅速的把从节点提升为主节点，为 Redis 服务器的宕机恢复节省了宝贵的时间；

- 防止数据丢失：当主服务器磁盘坏掉之后，其他从服务器还保留着相关的数据，不至于数据全部丢失。


主从复制的简单流程介绍：

- Master 可以拥有多个 slave 。

- 多个 slave 可以连接同一个 Master 外，还可以连接到其他的 slave 。

- 主从复制不会阻塞 Master 。 在主从复制时，Master 可以处理 client 请求。

- 提供系统的伸缩性。


主从复制简单原理的过程：

1. slave 与 master 建立连接，发送 _sync_ 同步命令。 也就是说当用户在 master 写入一条命令后，他们之间会通过一些算法把数据同步到每一个 slave 上。 

2. msater 会开启一个后台进程，将数据库快照保存到文件中。同时 master 主进程会开始收集新的写命令并缓存。 

3. 后台完成保存后，就将文件发送给 slave 。

4. slave 将此文件保存在硬盘上。


## 数据同步原理

### 主从第一次同步是"全量同步"

从机连上主机之后，主机会判断从机是否是第一次连上自己？在此之前是否有通不过数据？

主机如果发现这次是主从之间第一次通信，主机会执行一次 bgsave 持久化操作，生成 RDB 文件，并且将 RDB 文件发送给从机。

从机收到主机的 RDB 文件后，用 RDB 文件来“覆盖”自己的内存数据，从而达成主从初步一直的效果。

### 后续的同步时"增量同步"

全量同步过程中，以及全量同步之后，会涉及到一个 repl_baklog 文件<small>（ 逻辑上，它很像 aof 文件 ）</small>。

- 在 bgsave 生成 RDB 文件的过程中，如果主机收到了写操作命令，那么除了执行该命令之外，主机还会把命令<small>（ 本身 ）</small>写入到 repl_baklog 文件中；

- 在主从机工作期间，主机不是、也不可能时不停地执行将 RDB 文件内容发给从机<small>（ 这样的网咯代价太大，从而影响性能 ）</small>。在第一次全量同步之后，主机会将它后续执行的写命令都记录在 repl_backlog 文件中，再未来的通过周期中，主机只需要将过去一个周期中它所执行的写命令<small>（ 本身 ）</small>发送个从机，让从机执行即可实现主从数据的一致。

### 从机宕机、重启之后的同步

- 如果从机宕机、重启时间过长，从机会再次执行全量同步，逻辑上，等同于重新开始；

- 如果从机宕机、重启时间较短，从机只需要进行增量开发就可完成数据一致。
