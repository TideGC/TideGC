
---
alias: 关于 Redis 哨兵模式集群
tags: redis, 集群
---

## 关于 Redis 哨兵模式集群

之前有提到过，主从复制模式存在一个致命的问题，当主节点奔溃之后，需要人工干预才能恢复 Redis 的正常使用。

假设，有 A<small>（ 主 ）</small>、B、C 三台服务器组成的一个主从复制集群，当 A 发生故障时，你要做的事情有：

1. 把 B 服务器设置成主服务器；
2. 设置<small>（ 或保持 ）</small>C 服务器为从服务器，但是要重新配置它从 B 服务同步数据；
3. 重启、努力恢复 A 服务器的执行，一旦恢复成功，设置它为从服务器，并配置它从 B 服务器同步数据。

一旦这个事情发生在晚上或者从服务器节点很多的情况下，对于人工来说，这就是一件很麻烦的事情。

Redis Sentinel<small>（ 哨兵模式 ）</small>来把手动的过程变成自动的，让 Redis 拥有自动容灾恢复<small>（ failover ）</small>的能力的「自动化」工具。

哨兵模式如下所示：

![redis-sentinel-01.png|400](https://woniumd.oss-cn-hangzhou.aliyuncs.com/java/hemiao/20220627170703.png)

> [!tip] 提示
> Redis Sentinel 的最小分配单位是一主一从。

如果你担心哨兵节点发生故障，无法起到监视的作用，你可以配置多个哨兵，就像这样：

![redis-sentinel-02.png|400](https://woniumd.oss-cn-hangzhou.aliyuncs.com/java/hemiao/20220627170706.png)

通常情况下，线上环境中的哨兵节点<small>（ 即，sentinel 集群 ）</small>的数量取大于 1 的奇数，例如 3、5、7、9 。


Sentinel 工作方式：

### 下线规则

- 在"日常"工作中，每个哨兵会周期性<small>（ 1 秒 ）</small>向集群中的 master/slave 发送 PING 命令以判断对方的存在和网络的通畅。

- 如果某个 master 在规定的最大时长内<small>（ down-after-milliseconds 配置项 ）</small>未能及时回应，当前哨兵就认为该 master 是『**主观下线**』。

- 因为哨兵之间是有"沟通"的，一旦某个哨兵认为某个 master 是主观下线了，那么其它哨兵会确认这个 master 的状态。

- 一旦超过指定"人数"的哨兵<small>（ quorum 配置项 ）</small>都认为这个 master 挂了，那么，大家就一致性认为它是『**客观下线**』。<small>因此，quorum 值最好是超过哨兵数量的一般。</small>

- 处于客观下线状态的 redis 节点，逻辑上，就会排除在 Redis 的集群网络中，大家不再需要与它进行“交流”。

另外两个小细节：

- 如果没有足够数量的哨兵同意 Master 已经下线，那么在"那个"哨兵处标记的 master 的客观下线状态就会被移除，恢复成正常状态。当然，极端情况下，那个哨兵未来不久又会再次发现这个 master 下线了，如此反复...

- 哨兵除了每秒 1 次的频率向 master / slave 发 PING 命令以验证网络通畅、服务存活之外，还会以 10 秒 1 次的频率向 master / slave 发送 INFO 命令，要求 master / slave 上报自己的具体信息。

### 选举规则

一旦某个 master 被多个哨兵协商后认定为客观下线后，Redis 集群既要进入选举阶段，从下线的 master 的 slave 中选取一个顶替它的位置，称为新的 master 。

- 哨兵会优先考虑优先级<small>（ slave-priority 属性值，值越小优先级越高。0 表示不参与选举 ）</small>最高的 slave 来顶替它的 master 。

- 如果有优先级一样的多个 slave 参与选举，哨兵会考虑选择数据最新的那个 slave 来顶替它的 master 。

- 如果还有碰巧一样的情况，就以 slave 的 id 大小作为依据，谁小谁上。

- 一旦选出了新的 master 之后，哨兵会通知其它的 slave 重新执行 `slaveof` 命令，重置自己的主机，从新的主机处同步数据。


![redis-cluster-01](https://woniumd.oss-cn-hangzhou.aliyuncs.com/java/hemiao/20220627170708.png)


